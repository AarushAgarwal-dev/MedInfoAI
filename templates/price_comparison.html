{% extends "layout.html" %}
{% block title %}Price Comparison - MedInfo AI{% endblock %}

{% block content %}
<section id="price-comparison" class="section full-width-container" style="padding: 2rem 3rem; margin: 0; display: flex; flex-direction: column; height: 100%;">
    <h2 style="text-align: center; margin-bottom: 2rem;">Compare Medicine Prices</h2>
    
    <div class="search-form" style="display: flex; justify-content: center; margin-bottom: 2rem;">
        <input type="text" id="medicine-name-input" placeholder="Enter medicine name..." style="width: 50%; padding: 0.75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px 0 0 8px;">
        <button id="search-price-btn" style="padding: 0.75rem 1.5rem; font-size: 1rem; background-color: #3498db; color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer;">Search</button>
    </div>

    <div id="price-results-container" class="tool-card" style="flex-grow: 1; overflow-y: auto; display: none;">
        <!-- Price comparison results will be displayed here as a table -->
    </div>
    <div id="loader" style="display: none; text-align: center; margin-top: 2rem;">
        <p>Searching for the best prices...</p>
        <div class="spinner"></div> <!-- Basic spinner -->
    </div>
</section>

<style>
.price-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}
.price-table th, .price-table td {
    padding: 12px 15px;
    border: 1px solid #ddd;
    text-align: left;
}
.price-table th {
    background-color: #f4f4f4;
    font-weight: bold;
}
.price-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.price-table a {
    color: #3498db;
    text-decoration: none;
}
.price-table a:hover {
    text-decoration: underline;
}
.save-item-btn {
    padding: 5px 10px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
.spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: #3498db;
    animation: spin 1s ease infinite;
    margin: 1rem auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.getElementById('search-price-btn').addEventListener('click', async () => {
    const medicineName = document.getElementById('medicine-name-input').value.trim();
    if (!medicineName) {
        alert('Please enter a medicine name.');
        return;
    }

    const resultsContainer = document.getElementById('price-results-container');
    const loader = document.getElementById('loader');

    resultsContainer.style.display = 'none';
    resultsContainer.innerHTML = '';
    loader.style.display = 'block';

    try {
        const response = await fetch('/price-comparison', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ medicine_name: medicineName })
        });

        loader.style.display = 'none';

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'An unknown error occurred.');
        }

        const data = await response.json();
        resultsContainer.style.display = 'block';

        if (data.prices && data.prices.length > 0) {
            let tableHtml = `<h3>Prices for ${data.medicine_name}</h3>
                             <table class="price-table">
                                 <thead>
                                     <tr>
                                         <th>Store</th>
                                         <th>Price</th>
                                         <th>Link</th>
                                         <th>Action</th>
                                     </tr>
                                 </thead>
                                 <tbody>`;
            data.prices.forEach(item => {
                tableHtml += `<tr>
                                  <td>${item.store}</td>
                                  <td>${item.price}</td>
                                  <td><a href="${item.url}" target="_blank">Visit Store</a></td>
                                  <td><button class="save-item-btn" data-name="${data.medicine_name}" data-price="${item.price}" data-store="${item.store}">Save</button></td>
                              </tr>`;
            });
            tableHtml += '</tbody></table>';
            resultsContainer.innerHTML = tableHtml;
        } else {
            resultsContainer.innerHTML = `<p>Could not find any price information for "${medicineName}".</p>`;
        }
    } catch (error) {
        loader.style.display = 'none';
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
    }
});

document.getElementById('price-results-container').addEventListener('click', (event) => {
    if (event.target.classList.contains('save-item-btn')) {
        const item = {
            name: event.target.dataset.name,
            price: event.target.dataset.price,
            store: event.target.dataset.store,
            type: 'Medication'
        };
        saveItem(item);
        alert('Item saved!');
    }
});

function saveItem(item) {
    let savedItems = JSON.parse(localStorage.getItem('savedItems')) || [];
    savedItems.push(item);
    localStorage.setItem('savedItems', JSON.stringify(savedItems));
}
</script>
{% endblock %} 